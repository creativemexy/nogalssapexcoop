generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String?        @unique
  password      String
  firstName     String
  lastName      String
  phoneNumber   String?        @unique
  dateOfBirth   DateTime?
  address       String?
  profileImage  String?
  nextOfKinName String?
  nextOfKinPhone String?
  nin           String?        @unique
  role          UserRole       @default(MEMBER)
  isActive      Boolean        @default(true)
  isVerified    Boolean        @default(false)
  twoFactorEnabled Boolean     @default(false)
  twoFactorSecret  String?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  cooperativeId String?
  businessId    String?
  title         String?
  apex          Apex?
  contributions Contribution[]
  leader        Leader?
  loans         Loan[]
  payments      Payment[]
  transactions  Transaction[]
  business      Business?      @relation(fields: [businessId], references: [id])
  cooperative   Cooperative?   @relation(fields: [cooperativeId], references: [id])
  sessions      UserSession[]
  events        Event[]
  virtualAccount VirtualAccount?
  pendingContributions PendingContribution[]
  withdrawals Withdrawal[]
  expensesCreated Expense[]
  expensesApproved Expense[] @relation("ExpenseApprover")
  investments UserInvestment[]
  parentOrganizationsCreated ParentOrganization[] @relation("OrganizationCreator")
  parentOrganization ParentOrganization? @relation("OrganizationUser")
  chargeRecords ChargeRecord[]
  supportTickets SupportTicket[]

  @@map("users")
}

model Cooperative {
  id                 String         @id @default(cuid())
  name               String
  registrationNumber String         @unique
  address            String
  phoneNumber        String
  email              String
  description        String?
  logo               String?
  isActive           Boolean        @default(true)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  bankAccountNumber  String
  bankAccountName    String
  bankName           String
  city               String
  approved           Boolean?       @default(false)
  approvedAt         DateTime?
  approvedBy         String?
  bankId             String?
  lgaId              String?
  stateId            String?
  type               String?
  parentOrganizationId String?
  contributions      Contribution[]
  bank               Bank?          @relation(fields: [bankId], references: [id])
  lga                Lga?           @relation(fields: [lgaId], references: [id])
  state              State?         @relation(fields: [stateId], references: [id])
  parentOrganization ParentOrganization? @relation(fields: [parentOrganizationId], references: [id])
  leader             Leader?
  loans              Loan[]
  payments           Payment[]
  transactions       Transaction[]
  members            User[]
  pendingContributions PendingContribution[]
  investments        UserInvestment[]
  chargeRecords      ChargeRecord[]

  @@map("cooperatives")
}

model Leader {
  id                String      @id @default(cuid())
  userId            String      @unique
  cooperativeId     String      @unique
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  approved          Boolean?    @default(false)
  approvedAt        DateTime?
  endDate           DateTime?
  role              String?
  startDate         DateTime?
  title             String?
  bankAccountName   String?
  bankAccountNumber String?
  bankName          String?
  cooperative       Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("leaders")
}

model Apex {
  id        String   @id @default(cuid())
  userId    String   @unique
  region    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("apex")
}

model Business {
  id                 String        @id @default(cuid())
  name               String
  registrationNumber String        @unique
  businessType       String
  address            String
  phoneNumber        String
  email              String
  description        String?
  logo               String?
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  payments           Payment[]
  transactions       Transaction[]
  users              User[]
  chargeRecords      ChargeRecord[]

  @@map("businesses")
}

model Contribution {
  id            String      @id @default(cuid())
  userId        String
  cooperativeId String
  amount        Decimal
  description   String?
  date          DateTime    @default(now())
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("contributions")
}

model Loan {
  id            String      @id @default(cuid())
  userId        String
  cooperativeId String
  amount        Decimal
  purpose       String
  interestRate  Decimal
  duration      Int
  status        String      @default("PENDING")
  approvedBy    String?
  approvedAt    DateTime?
  startDate     DateTime?
  endDate       DateTime?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("loans")
}

model Transaction {
  id            String          @id @default(cuid())
  userId        String
  cooperativeId String?
  businessId    String?
  type          TransactionType
  amount        Decimal
  description   String?
  reference     String          @unique
  status        PaymentStatus   @default(PENDING)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  payment       Payment?
  business      Business?       @relation(fields: [businessId], references: [id])
  cooperative   Cooperative?    @relation(fields: [cooperativeId], references: [id])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model Payment {
  id                 String        @id @default(cuid())
  transactionId      String        @unique
  userId             String
  cooperativeId      String?
  businessId         String?
  amount             Decimal
  currency           String        @default("NGN")
  paymentMethod      String        @default("PAYSTACK")
  paystackReference  String?       @unique
  paystackAccessCode String?
  status             PaymentStatus @default(PENDING)
  metadata           Json?
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  business           Business?     @relation(fields: [businessId], references: [id])
  cooperative        Cooperative?  @relation(fields: [cooperativeId], references: [id])
  transaction        Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Log {
  id        String   @id @default(cuid())
  userId    String
  userEmail String
  action    String
  timestamp DateTime @default(now())

  @@map("logs")
}

model Bank {
  id           String        @id @default(cuid())
  name         String        @unique
  code         String        @unique
  slug         String?       @unique
  longcode     String?
  gateway      String?
  payWithBank  Int?          @default(0)
  active       Int?          @default(1)
  country      String?
  currency     String?
  type         String?
  isDeleted    Int?          @default(0)
  paystackCode String?       // Paystack bank code for account resolution
  cooperatives Cooperative[]

  @@map("banks")
}

model State {
  id           String        @id @default(cuid())
  name         String        @unique
  cooperatives Cooperative[]
  lgas         Lga[]

  @@map("states")
}

model Lga {
  id           String        @id @default(cuid())
  name         String
  stateId      String
  cooperatives Cooperative[]
  state        State         @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@map("lgas")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model Partner {
  id          String   @id @default(cuid())
  name        String
  logo        String   // URL to logo image
  website     String?  // Optional partner website
  description String?  // Optional description
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  sessionId String   @unique
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model EmergencyAlert {
  id        String   @id @default(cuid())
  title     String
  message   String
  severity  String   // e.g., 'CRITICAL', 'WARNING'
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  createdBy String   // userId of the super admin
}

model SystemSettings {
  id                String   @id @default(cuid())
  category          String   // 'general', 'branding', 'payment', 'notification', 'security', 'privacy'
  key               String   // Setting key
  value             String   // Setting value (JSON string for complex data)
  description       String?  // Human-readable description
  isActive          Boolean  @default(true)
  updatedAt         DateTime @updatedAt
  updatedBy         String   // userId of the admin who updated
  
  @@unique([category, key])
  @@map("system_settings")
}

model Occupation {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("occupations")
}

model NotificationLog {
  id            String            @id @default(cuid())
  type          NotificationType  // 'EMAIL' or 'SMS'
  recipient     String            // email address or phone number
  subject       String?           // email subject (null for SMS)
  message       String            // message content
  status        NotificationStatus @default(PENDING) // 'PENDING', 'SENT', 'FAILED'
  provider      String?           // 'resend', 'sms_provider', etc.
  providerId    String?           // external provider message ID
  cost          Float?            // cost in Naira (for SMS)
  errorMessage  String?           // error details if failed
  metadata      Json?             // additional data (user info, etc.)
  sentAt        DateTime?         // when notification was sent
  createdAt     DateTime          @default(now())
  
  @@map("notification_logs")
}

enum NotificationType {
  EMAIL
  SMS
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum UserRole {
  SUPER_ADMIN
  APEX
  LEADER
  COOPERATIVE
  MEMBER
  BUSINESS
  FINANCE
  APEX_FUNDS
  NOGALSS_FUNDS
  PARENT_ORGANIZATION
}

enum PaymentStatus {
  PENDING
  SUCCESSFUL
  FAILED
  CANCELLED
}

enum TransactionType {
  CONTRIBUTION
  LOAN
  WITHDRAWAL
  FEE
  INVESTMENT
  REPAYMENT
}

model Event {
  id          String      @id @default(cuid())
  title       String
  description String?
  date        DateTime
  time        String?
  location    String?
  image       String?
  category    String?
  attendees   Int?        @default(0)
  isPublished Boolean     @default(false)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdBy   String
  creator     User        @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("events")
}

model VirtualAccount {
  id            String   @id @default(cuid())
  userId        String   @unique
  accountType   String   // 'MEMBER', 'LEADER', 'COOPERATIVE'
  accountName   String
  accountNumber String
  bankName      String
  bankCode      String
  customerCode  String   @unique
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("virtual_accounts")
}

model PendingRegistration {
  id        String   @id @default(cuid())
  type      String   // 'COOPERATIVE', 'MEMBER'
  data      String   // JSON string of registration data
  reference String   @unique
  status    String   @default("PENDING") // 'PENDING', 'COMPLETED', 'FAILED'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pending_registrations")
}

model PendingContribution {
  id            String   @id @default(cuid())
  userId        String
  cooperativeId String
  amount        Decimal
  reference     String   @unique
  status        String   @default("PENDING") // 'PENDING', 'COMPLETED', 'FAILED'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("pending_contributions")
}

model Withdrawal {
  id          String   @id @default(cuid())
  userId      String
  amount      Decimal
  reason      String
  status      String   @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED', 'PROCESSED'
  requestedAt DateTime @default(now())
  processedAt DateTime?
  processedBy String?
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("withdrawals")
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  status    String   @default("UNREAD") // 'UNREAD', 'READ', 'REPLIED', 'ARCHIVED'
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contact_messages")
}

model Expense {
  id          String   @id @default(cuid())
  title       String
  description String?
  amount      Decimal
  category    String   // 'OFFICE_SUPPLIES', 'UTILITIES', 'TRAVEL', 'MARKETING', 'MAINTENANCE', 'OTHER'
  status      String   @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED', 'PAID'
  receiptUrl  String?
  createdBy   String
  approvedBy  String?
  approvedAt  DateTime?
  paidAt      DateTime?
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  creator     User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  approver    User?    @relation("ExpenseApprover", fields: [approvedBy], references: [id])

  @@map("expenses")
}

model UserInvestment {
  id            String   @id @default(cuid())
  userId        String
  cooperativeId String
  amount        Int      // Amount in kobo
  type          String   // 'FIXED_DEPOSIT', 'SAVINGS_BOND', 'TREASURY_BILL', 'MUTUAL_FUND'
  status        String   @default("PENDING") // 'PENDING', 'ACTIVE', 'COMPLETED', 'CANCELLED'
  description   String?
  startDate     DateTime?
  endDate       DateTime?
  interestRate  Decimal?
  maturityAmount Int?    // Maturity amount in kobo
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  @@map("investments")
}

model ParentOrganization {
  id            String   @id @default(cuid())
  name          String
  description   String?
  contactEmail  String
  contactPhone  String?
  address       String?
  website       String?
  logo          String?
  parentId      String?  // Self-referencing for hierarchy
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String   // User ID who created this organization
  
  // User account fields
  userId        String?  @unique // Associated user account
  defaultPassword String? // Default password for the organization
  
  // CAC Registration Details
  rcNumber      String?
  companyType   String?
  registrationDate DateTime?
  businessActivities String?
  
  // Additional CAC Information
  tin           String?
  vatNumber     String?
  registryNumber String?
  companyStatus String?
  city          String?
  state         String?
  lga           String?
  branchAddress String?
  objectives    String?
  
  // Share Capital Information
  shareCapitalInWords String?
  paidUpCapital       String?
  subscribedShareCapital String?
  sharesIssued        String?
  sharesValue         String?
  
  // Company Contact Persons
  companyContactName  String?
  companyContactEmail String?
  companyContactPhone String?
  
  // Key Personnel - Secretary
  secretaryName    String?
  secretaryEmail   String?
  secretaryPhone   String?
  secretaryAddress String?
  
  // Directors
  director1Name        String?
  director1Email       String?
  director1Phone       String?
  director1Address     String?
  director1Occupation  String?
  director1Nationality String?
  
  // Shareholders
  shareholder1Name        String?
  shareholder1Shares      String?
  shareholder1Percentage  String?
  shareholder1Address     String?
  shareholder1Nationality String?
  
  // President Details
  presidentFirstName String?
  presidentLastName  String?
  presidentEmail     String?
  presidentPhone     String?
  
  // Bank Details
  bankName           String?
  bankAccountNumber  String?
  bankAccountName    String?
  
  // Self-referencing relationship for hierarchy
  parent        ParentOrganization? @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children      ParentOrganization[] @relation("OrganizationHierarchy")
  
  // Relations to other entities
  cooperatives  Cooperative[]
  creator       User @relation("OrganizationCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  user          User? @relation("OrganizationUser", fields: [userId], references: [id], onDelete: SetNull)
  supportTickets SupportTicket[]

  @@map("parent_organizations")
}

// NDPA Compliance Models
model DataProcessingActivity {
  id               String   @id @default(cuid())
  purpose          String
  legalBasis       String
  dataCategories   String[]
  recipients       String[]
  retentionPeriod  Int      // in days
  securityMeasures String[]
  riskLevel        String   @default("low")
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String

  // Relations
  consentRecords   ConsentRecord[]
  dataBreaches     DataBreach[]
  auditLogs        AuditLog[]

  @@map("data_processing_activities")
}

model ConsentRecord {
  id             String   @id @default(cuid())
  dataSubjectId  String
  purpose        String
  consentGiven   Boolean
  consentDate    DateTime
  withdrawalDate DateTime?
  ipAddress      String
  userAgent      String
  consentVersion String   @default("1.0")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  dataProcessingActivityId String?
  dataProcessingActivity   DataProcessingActivity? @relation(fields: [dataProcessingActivityId], references: [id])

  @@map("consent_records")
}

model DataBreach {
  id                      String   @id @default(cuid())
  description             String
  categories              String[]
  approximateDataSubjects  Int
  likelyConsequences      String
  measuresProposed        String
  reportedToAuthority     Boolean  @default(false)
  reportedToDataSubjects  Boolean  @default(false)
  reportedAt              DateTime
  status                  String   @default("detected")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  reportedBy              String

  // Relations
  dataProcessingActivityId String?
  dataProcessingActivity   DataProcessingActivity? @relation(fields: [dataProcessingActivityId], references: [id])

  @@map("data_breaches")
}

model DataSubjectRequest {
  id          String   @id @default(cuid())
  dataSubjectId String
  requestType String   // access, rectification, erasure, portability, objection
  description String
  status      String   @default("pending") // pending, in_progress, completed, rejected
  response    String?
  requestedAt DateTime @default(now())
  completedAt DateTime?
  handledBy   String?

  @@map("data_subject_requests")
}

model PrivacyImpactAssessment {
  id                      String   @id @default(cuid())
  activityId              String
  purpose                 String
  legalBasis              String
  dataCategories          String[]
  riskLevel               String
  mitigationMeasures      String[]
  dataMinimization        String
  purposeLimitation       String
  storageLimitation       String
  accuracy                String
  security                String
  transparency            String
  assessmentDate          DateTime @default(now())
  assessedBy              String
  approvedBy              String?

  @@map("privacy_impact_assessments")
}

model AuditLog {
  id                      String   @id @default(cuid())
  userId                  String?
  action                  String
  resource                String
  resourceId              String?
  oldValues               Json?
  newValues               Json?
  ipAddress               String
  userAgent               String
  timestamp               DateTime @default(now())
  dataProcessingActivityId String?
  dataProcessingActivity   DataProcessingActivity? @relation(fields: [dataProcessingActivityId], references: [id])

  @@map("audit_logs")
}

model DataRetentionPolicy {
  id              String   @id @default(cuid())
  dataCategory    String
  retentionPeriod Int      // in days
  legalBasis      String
  description     String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String

  @@map("data_retention_policies")
}

// Charge Tracking Model - Records charges without applying them to payments
model ChargeRecord {
  id                String   @id @default(cuid())
  transactionId     String?  // Reference to the transaction if available
  userId            String
  cooperativeId     String?
  businessId        String?
  chargeType        String
  baseAmount        Float
  chargeAmount      Float
  chargePercentage  Float
  totalAmount       Float
  paymentType       String
  paymentMethod     String
  status            String   @default("recorded")
  description       String?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User         @relation(fields: [userId], references: [id])
  cooperative       Cooperative? @relation(fields: [cooperativeId], references: [id])
  business          Business?    @relation(fields: [businessId], references: [id])

  @@map("charge_records")
}

model SupportTicket {
  id                  String   @id @default(cuid())
  subject             String
  description         String
  status              SupportTicketStatus @default(OPEN)
  priority            SupportTicketPriority @default(MEDIUM)
  category            SupportTicketCategory @default(GENERAL)
  parentOrganizationId String?
  userId              String
  assignedTo          String?
  resolution          String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  parentOrganization  ParentOrganization? @relation(fields: [parentOrganizationId], references: [id])
  user                User @relation(fields: [userId], references: [id])

  @@map("support_tickets")
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SupportTicketCategory {
  TECHNICAL
  BILLING
  GENERAL
  FEATURE_REQUEST
}
